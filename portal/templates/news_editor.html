{% extends 'base.html' %}
{% load static %}

{% block title %}Editor de Notícias - Portal Inovaí{% endblock %}

{% block extra_styles %}
<style>
    /* Estilos Específicos do Editor */
    #sidebar {
        height: calc(100vh - 80px);
        /* Ajuste baseado na altura da navbar */
        position: sticky;
        top: 80px;
    }

    .tool-item {
        cursor: grab;
        transition: all 0.2s;
    }

    .tool-item:active {
        cursor: grabbing;
    }

    .tool-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    #canvas {
        min-height: calc(100vh - 80px);
    }

    /* Estilos do Canvas e Blocos */
    .editor-block {
        position: relative;
        border: 2px solid transparent;
        transition: border-color 0.2s;
    }

    .editor-block:hover {
        border-color: #3b82f6;
        /* brand-blue */
    }

    .editor-block .block-actions {
        display: none;
        position: absolute;
        top: -10px;
        right: 10px;
        background: white;
        border-radius: 9999px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }

    .editor-block:hover .block-actions {
        display: flex;
    }

    /* Área de Drop Fantasma */
    .drop-indicator {
        height: 4px;
        background-color: #3b82f6;
        margin: 4px 0;
        border-radius: 2px;
        transition: all 0.2s;
        display: none;
    }

    .drop-indicator.active {
        display: block;
    }

    /* Botão Flutuante de Adicionar */
    #floatingAddBtn {
        position: relative;
        margin: 20px auto 0;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 20;
    }

    #canvas:hover #floatingAddBtn {
        opacity: 1;
    }
</style>
<style>
    /* Navbar Overrides for Editor */
    #navbar {
        position: relative !important;
        background-color: white !important;
        border-bottom: 1px solid #e5e7eb;
        box-shadow: none !important;
    }

    .dark #navbar {
        background-color: #111827 !important;
        border-color: #374151;
    }

    #navbar a,
    #navbar button,
    #navbar i {
        color: #374151 !important;
        /* gray-700 */
    }

    .dark #navbar a,
    .dark #navbar button,
    .dark #navbar i {
        color: #d1d5db !important;
        /* gray-300 */
    }

    /* Logo Filter Reset */
    #navbar img {
        filter: none !important;
    }

    /* Adjust main container since navbar is relative */
    .editor-container {
        padding-top: 0 !important;
    }
</style>
{% endblock %}

{% block navbar_scroll_logic %}
// Scroll logic disabled for Editor
{% endblock %}

{% block content %}
<div class="flex bg-gray-50 dark:bg-gray-950 min-h-screen editor-container">

    <!-- Sidebar de Ferramentas -->
    <aside id="sidebar"
        class="w-64 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 p-4 overflow-y-auto hidden md:block z-40">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Blocos de Construção</h3>

        <div class="space-y-3">
            <!-- Título -->
            <div class="tool-item bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center gap-3 shadow-sm"
                draggable="true" data-type="title">
                <div class="w-8 h-8 rounded bg-blue-100 text-blue-600 flex items-center justify-center">
                    <i class="bi bi-type-h1"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Título</span>
            </div>

            <!-- Subtítulo -->
            <div class="tool-item bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center gap-3 shadow-sm"
                draggable="true" data-type="subtitle">
                <div class="w-8 h-8 rounded bg-blue-100 text-blue-600 flex items-center justify-center">
                    <i class="bi bi-type-h2"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Subtítulo</span>
            </div>

            <!-- Parágrafo -->
            <div class="tool-item bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center gap-3 shadow-sm"
                draggable="true" data-type="paragraph">
                <div class="w-8 h-8 rounded bg-gray-100 text-gray-600 flex items-center justify-center">
                    <i class="bi bi-text-paragraph"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Parágrafo</span>
            </div>

            <!-- Imagem -->
            <div class="tool-item bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center gap-3 shadow-sm"
                draggable="true" data-type="image">
                <div class="w-8 h-8 rounded bg-purple-100 text-purple-600 flex items-center justify-center">
                    <i class="bi bi-image"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Imagem</span>
            </div>

            <!-- Carrossel -->
            <div class="tool-item bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center gap-3 shadow-sm"
                draggable="true" data-type="carousel">
                <div class="w-8 h-8 rounded bg-pink-100 text-pink-600 flex items-center justify-center">
                    <i class="bi bi-images"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Carrossel</span>
            </div>

            <!-- Imagem com Texto -->
            <div class="tool-item bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center gap-3 shadow-sm"
                draggable="true" data-type="image-text">
                <div class="w-8 h-8 rounded bg-orange-100 text-orange-600 flex items-center justify-center">
                    <i class="bi bi-layout-sidebar"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Imagem + Texto</span>
            </div>
        </div>
    </aside>

    <!-- Canvas de Preview -->
    <main class="flex-grow p-8 flex justify-center bg-gray-50 dark:bg-gray-950 relative">
        <!-- Área da Folha A4/Conteúdo -->
        <div id="canvas"
            class="w-full max-w-4xl bg-white dark:bg-gray-900 shadow-xl rounded-xl p-8 min-h-[800px] border border-gray-200 dark:border-gray-800 relative">
            <div class="text-center text-gray-300 dark:text-gray-700 mt-20 pointer-events-none" id="emptyState">
                <i class="bi bi-arrow-left-short text-4xl"></i>
                <p>Arraste elementos para começar</p>
            </div>

            <!-- Botão Flutuante (+) -->
            <button id="floatingAddBtn"
                class="bg-brand-blue hover:bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition transform hover:scale-110 active:scale-90"
                title="Adicionar Bloco">
                <i class="bi bi-plus-lg text-xl"></i>
            </button>

            <!-- Menu do Botão Flutuante (Oculto por padrão) -->
            <div id="addMenu"
                class="absolute hidden bg-white dark:bg-gray-800 shadow-xl rounded-lg border border-gray-100 dark:border-gray-700 p-2 z-30 w-48">
                <button
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm flex items-center gap-2"
                    onclick="addBlock('title')"><i class="bi bi-type-h1 text-blue-500"></i> Título</button>
                <button
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm flex items-center gap-2"
                    onclick="addBlock('subtitle')"><i class="bi bi-type-h2 text-blue-500"></i> Subtítulo</button>
                <button
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm flex items-center gap-2"
                    onclick="addBlock('paragraph')"><i class="bi bi-text-paragraph text-gray-500"></i>
                    Parágrafo</button>
                <button
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm flex items-center gap-2"
                    onclick="addBlock('image')"><i class="bi bi-image text-purple-500"></i> Imagem</button>
                <button
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm flex items-center gap-2"
                    onclick="addBlock('carousel')"><i class="bi bi-images text-pink-500"></i> Carrossel</button>
                <button
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm flex items-center gap-2"
                    onclick="addBlock('image-text')"><i class="bi bi-layout-sidebar text-orange-500"></i> Imagem +
                    Texto</button>
            </div>
        </div>
    </main>
</div>

<!-- Template Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tools = document.querySelectorAll('.tool-item');
        const canvas = document.getElementById('canvas');
        const emptyState = document.getElementById('emptyState');
        const floatingBtn = document.getElementById('floatingAddBtn');
        const addMenu = document.getElementById('addMenu');

        let draggedType = null;
        let insertionIndex = -1; // -1 significa fim, senão index do filho

        // --- Drag & Drop Start ---
        tools.forEach(tool => {
            tool.addEventListener('dragstart', (e) => {
                draggedType = tool.dataset.type;
                e.dataTransfer.setData('text/plain', draggedType);
                e.dataTransfer.effectAllowed = 'copy';
            });
        });

        // --- Drag Over Canvas ---
        canvas.addEventListener('dragover', (e) => {
            e.preventDefault(); // Necessário para permitir o drop
            e.dataTransfer.dropEffect = 'copy';

            // Lógica para mostrar onde será inserido (indicador visual simples aqui)
            // Para simplicidade, apenas permitimos append no final por enquanto nesta versão inicial
            canvas.style.borderColor = '#3b82f6';
        });

        canvas.addEventListener('dragleave', (e) => {
            canvas.style.borderColor = '';
        });

        // --- Drop on Canvas ---
        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            canvas.style.borderColor = '';

            const type = e.dataTransfer.getData('text/plain');
            if (type) {
                createBlock(type);
            }
        });

        // --- Floating Button Logic ---
        // O botão deve seguir o último elemento ou ser posicionado manualmente?
        // A especificação diz: "botão com sinal de + ... irá descer a cada novo elemento".
        // Vamos posicioná-lo no final do container sempre.

        // updateFloatingButtonPosition function removed as it is not needed with relative positioning

        floatingBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // Mostrar menu na posição do botão
            const rect = floatingBtn.getBoundingClientRect();
            // Ajustar posição do menu relativo ao canvas
            // Mas nosso menu está dentro do canvas absolute
            // addMenu.style.display = 'block'; // REMOVED: Conflicts with .hidden class
            addMenu.style.removeProperty('display'); // Ensure no inline style persists
            addMenu.style.top = (floatingBtn.offsetTop + 40) + 'px';
            addMenu.style.left = (floatingBtn.offsetLeft) + 'px';
            addMenu.classList.remove('hidden');
        });

        // Fechar menu ao clicar fora
        document.addEventListener('click', (e) => {
            if (!addMenu.contains(e.target) && e.target !== floatingBtn) {
                addMenu.classList.add('hidden');
            }
        });

        // Expor função addBlock globalmente para o onclick do menu html
        window.addBlock = function (type) {
            createBlock(type);
            addMenu.classList.add('hidden');
        }

        // --- Block Creation Logic ---
        function createBlock(type) {
            if (emptyState) emptyState.remove();

            const block = document.createElement('div');
            block.className = 'editor-block mb-4 group relative py-2 px-4 hover:bg-gray-50 rounded-lg';

            // Botões de Ação do Bloco (Excluir/Mover)
            const actions = document.createElement('div');
            actions.className = 'block-actions translate-x-1/2 -top-3 right-1/2 flex gap-1 p-1 bg-white border border-gray-200 shadow rounded-full opacity-0 group-hover:opacity-100 transition-opacity';
            actions.innerHTML = `
                <button class="p-1 text-red-500 hover:bg-red-50 rounded-full" onclick="this.closest('.editor-block').remove()"><i class="bi bi-trash"></i></button>
                <div class="h-full w-px bg-gray-200 mx-1"></div>
                <button class="p-1 text-gray-500 hover:bg-gray-100 rounded-full cursor-move"><i class="bi bi-grip-vertical"></i></button>
            `;
            block.appendChild(actions);

            let contentHTML = '';

            switch (type) {
                case 'title':
                    contentHTML = `<h1 class="text-4xl font-bold text-gray-900 outline-none" contenteditable="true">Título da Notícia</h1>`;
                    break;
                case 'subtitle':
                    contentHTML = `<h2 class="text-2xl font-semibold text-gray-700 outline-none mt-2" contenteditable="true">Subtítulo Explicativo</h2>`;
                    break;
                case 'paragraph':
                    contentHTML = `<p class="text-gray-600 leading-relaxed outline-none" contenteditable="true">Comece a escrever o conteúdo do parágrafo aqui...</p>`;
                    break;
                case 'image':
                    contentHTML = `
                        <div class="w-full h-64 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-200 transition" onclick="this.querySelector('input').click()">
                            <i class="bi bi-image text-3xl mb-2"></i>
                            <span class="text-sm pointer-events-none">Clique ou arraste uma imagem</span>
                            <input type="file" class="hidden" accept="image/*" onchange="previewImage(this)">
                        </div>
                    `;
                    break;
                case 'carousel':
                    contentHTML = `
                        <div class="w-full relative bg-gray-100 rounded-xl overflow-hidden h-72 group-carousel cursor-pointer" onclick="this.querySelector('input').click()">
                            <div class="absolute inset-0 flex items-center justify-center text-gray-400 group-hover:bg-gray-200 transition">
                                <span class="flex flex-col items-center pointer-events-none"><i class="bi bi-images text-3xl mb-2"></i> Carrossel: Clique para adicionar</span>
                            </div>
                            <input type="file" class="hidden" accept="image/*" multiple onchange="previewCarousel(this)">
                            
                            <div class="hidden carousel-controls absolute inset-0 pointer-events-none">
                                <button class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/30 hover:bg-white/50 p-2 rounded-full text-white pointer-events-auto"><i class="bi bi-chevron-left"></i></button>
                                <button class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/30 hover:bg-white/50 p-2 rounded-full text-white pointer-events-auto"><i class="bi bi-chevron-right"></i></button>
                            </div>
                        </div>
                    `;
                    break;
                case 'image-text':
                    contentHTML = `
                        <div class="flex flex-col md:flex-row gap-6 items-center">
                            <div class="w-full md:w-1/2 h-48 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-200 transition" onclick="this.querySelector('input').click()">
                                <i class="bi bi-image text-2xl mb-1 pointer-events-none"></i>
                                <span class="text-xs pointer-events-none">Adicionar Imagem</span>
                                <input type="file" class="hidden" accept="image/*" onchange="previewImage(this)">
                            </div>
                            <div class="w-full md:w-1/2">
                                <h3 class="text-xl font-bold mb-2 outline-none" contenteditable="true">Título da Seção</h3>
                                <p class="text-gray-600 outline-none" contenteditable="true">Texto descritivo ao lado da imagem...</p>
                            </div>
                        </div>
                    `;
                    break;
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.innerHTML = contentHTML;
            block.appendChild(contentWrapper);

            // Inserir antes do botão flutuante e menu
            canvas.insertBefore(block, floatingBtn);

            // Animação de entrada
            block.animate([
                { opacity: 0, transform: 'translateY(10px)' },
                { opacity: 1, transform: 'translateY(0)' }
            ], { duration: 300, easing: 'ease-out' });
        }

        // --- Helper: Preview Image ---
        window.previewImage = function (input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const parent = input.parentElement;
                    // Resetar classes para remover estilo de placeholder e permitir clique total
                    // Resetar classes para remover estilo de placeholder e permitir clique total
                    // VOLTANDO para altura fixa padrão (h-96) com object-cover
                    parent.className = 'w-full h-96 relative rounded-lg overflow-hidden group cursor-pointer';
                    parent.style.height = '';

                    parent.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-cover">
                        <!-- Overlay de troca -->
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                            <span class="text-white font-medium flex items-center gap-2"><i class="bi bi-pencil"></i> Trocar Imagem</span>
                        </div>
                        <input type="file" class="hidden" accept="image/*" onchange="previewImage(this)">
                    `;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Helper: Preview Carousel ---
        window.previewCarousel = function (input) {
            if (input.files && input.files.length > 0) {
                const parent = input.parentElement;
                const mode = parent.dataset.uploadMode || 'replace'; // 'replace' or 'append'

                // Manter estilos base
                parent.className = 'w-full h-96 relative rounded-xl overflow-hidden bg-gray-900 group cursor-default';
                parent.onclick = null; // Remove o click global

                const files = Array.from(input.files);
                const promises = files.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(newImages => {
                    // Recuperar imagens existentes se modo for append
                    let currentImages = [];
                    if (mode === 'append' && parent.storedImages) {
                        currentImages = parent.storedImages;
                    }

                    // Combinar imagens
                    const allImages = [...currentImages, ...newImages];
                    parent.storedImages = allImages; // Salvar estado no elemento DOM

                    // Resetar input para permitir selecionar o mesmo arquivo novamente se necessário
                    input.value = '';

                    // Renderizar Carrossel
                    renderCarousel(parent, allImages);
                });
            }
        }

        // --- Helper: Render Carousel ---
        function renderCarousel(parent, images) {
            // Gerar HTML dos Slides
            let slidesHTML = images.map((src, index) => `
                <div class="min-w-full h-full relative">
                    <img src="${src}" class="w-full h-full object-cover">
                </div>
             `).join('');

            let indicatorsHTML = images.map((_, index) => `
                <button class="w-2 h-2 rounded-full bg-white/50 hover:bg-white transition-all ${index === 0 ? 'bg-white w-4' : ''}" 
                        data-index="${index}"></button>
             `).join('');

            parent.innerHTML = `
                <!-- Slides Container -->
                <div class="slides flex transition-transform duration-500 h-full w-full" style="transform: translateX(0%);">
                    ${slidesHTML}
                </div>
                
                <!-- Controls -->
                ${images.length > 1 ? `
                    <button class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 hover:bg-black/50 p-2 rounded-full text-white transition backdrop-blur-sm z-10 prev-btn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 hover:bg-black/50 p-2 rounded-full text-white transition backdrop-blur-sm z-10 next-btn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    
                    <!-- Indicators -->
                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10 indicators-container">
                        ${indicatorsHTML}
                    </div>
                ` : ''}

                <!-- Actions Overlay (Top Right) -->
                <div class="absolute top-2 right-2 flex gap-2 z-20 opacity-0 group-hover:opacity-100 transition duration-300">
                    <!-- Botão Adicionar Mais -->
                    <div class="bg-blue-600 rounded-full p-2 cursor-pointer hover:bg-blue-700 shadow-md text-white" 
                         title="Adicionar Mais Imagens" 
                         onclick="this.closest('.group').dataset.uploadMode = 'append'; this.closest('.group').querySelector('input').click()">
                        <i class="bi bi-plus-lg"></i>
                    </div>
                    <!-- Botão Remover Atual -->
                    <div class="bg-red-500 rounded-full p-2 cursor-pointer hover:bg-red-600 shadow-md text-white delete-btn" 
                         title="Remover Imagem Atual">
                        <i class="bi bi-trash"></i>
                    </div>
                    <!-- Botão Editar Tudo -->
                    <div class="bg-black/50 rounded-full p-2 cursor-pointer hover:bg-black/70 shadow-md text-white" 
                         title="Substituir Todas" 
                         onclick="this.closest('.group').dataset.uploadMode = 'replace'; this.closest('.group').querySelector('input').click()">
                        <i class="bi bi-pencil"></i>
                    </div>
                </div>
                
                <input type="file" class="hidden" accept="image/*" multiple onchange="previewCarousel(this)">
             `;

            // Inicializar Lógica
            if (images.length > 0) {
                initCarouselLogic(parent, images.length);
            }
        }

        // --- Helper: Init Carousel Logic ---
        function initCarouselLogic(container, totalSlides) {
            let currentSlide = 0;
            const slidesContainer = container.querySelector('.slides');
            const prevBtn = container.querySelector('.prev-btn');
            const nextBtn = container.querySelector('.next-btn');
            const deleteBtn = container.querySelector('.delete-btn');
            const indicators = container.querySelectorAll('.indicators-container button');

            function updateSlide() {
                // Garantir bounds
                if (totalSlides === 0) {
                    currentSlide = 0;
                    return; // No slides to update
                }
                if (currentSlide >= totalSlides) currentSlide = totalSlides - 1;
                if (currentSlide < 0) currentSlide = 0;

                slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
                indicators.forEach((ind, idx) => {
                    if (idx === currentSlide) {
                        ind.classList.remove('bg-white/50');
                        ind.classList.add('bg-white', 'w-4');
                    } else {
                        ind.classList.add('bg-white/50');
                        ind.classList.remove('bg-white', 'w-4');
                    }
                });
            }

            if (prevBtn) prevBtn.addEventListener('click', (e) => { e.stopPropagation(); currentSlide = (currentSlide - 1 + totalSlides) % totalSlides; updateSlide(); });
            if (nextBtn) nextBtn.addEventListener('click', (e) => { e.stopPropagation(); currentSlide = (currentSlide + 1) % totalSlides; updateSlide(); });

            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Remover esta imagem do carrossel?')) {
                        // Remover imagem atual do array armazenado
                        const currentImages = container.storedImages;
                        currentImages.splice(currentSlide, 1);
                        container.storedImages = currentImages;

                        // Re-renderizar
                        if (currentImages.length === 0) {
                            // Resetar para estado inicial (placeholder)
                            container.className = 'w-full h-72 relative rounded-xl overflow-hidden group-carousel cursor-pointer';
                            container.onclick = function () { this.querySelector('input').click() };
                            container.innerHTML = `
                                <div class="absolute inset-0 flex items-center justify-center text-gray-400 group-hover:bg-gray-200 transition">
                                    <span class="flex flex-col items-center pointer-events-none"><i class="bi bi-images text-3xl mb-2"></i> Carrossel: Clique para adicionar</span>
                                </div>
                                <input type="file" class="hidden" accept="image/*" multiple onchange="previewCarousel(this)">
                           `;
                        } else {
                            renderCarousel(container, currentImages);
                        }
                    }
                });
            }

            indicators.forEach((ind, index) => {
                ind.addEventListener('click', (e) => { e.stopPropagation(); currentSlide = index; updateSlide(); });
            });
            updateSlide(); // Initial update to set correct slide and indicators
        }
    });
</script>
{% endblock %}